!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.casperapi=t():e.casperapi=t()}(window,function(){return function(e){var t={};function n(r){if(t[r])return t[r].exports;var o=t[r]={i:r,l:!1,exports:{}};return e[r].call(o.exports,o,o.exports,n),o.l=!0,o.exports}return n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:r})},n.r=function(e){Object.defineProperty(e,"__esModule",{value:!0})},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=11)}([function(e,t,n){"use strict";e.exports=function(e){var t=void 0,n=void 0,r=new Promise(function(e,r){t=e,n=r});return r.subscribers={},r.emit=function(e,t){this.subscribers[e]&&this.subscribers[e].forEach(function(e){return e(t)})}.bind(r),r.on=function(e,t){return this.subscribers[e]||(this.subscribers[e]=[]),this.subscribers[e].push(t),this}.bind(r),e(t,n,r.emit),r}},function(e,t,n){"use strict";var r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},o=n(9),i=n(8),u=n(7),c=n(6),a=c.isFile,s=c.getFileSize,f=function(e,t,n){switch(t){case Number:switch(n.type){case"Integer":return parseInt(n.value);case"ByteArray":var o=e.u.reverseHex(n.value);return parseInt(o,16)}case String:return e.u.hexstring2str(n.value);default:throw new Error("casperapi: Unsupported neo decode pair: "+n.type+" -> "+r(t()))}};e.exports={parseSCString:function(e){for(var t=e.substring(2),n=[],r=0;r<t.length;r+=2)n.push(parseInt(t.substr(r,2),16));return String.fromCharCode.apply(0,n.filter(function(e){return 0!==e}))},isFile:a,getFileSize:s,uuidToHash:function(e){var t=i.decode(e);return"0x"+o(t)},nodeIdToBytes:function(e){var t="0x"===e.substr(0,2)?e.substr(2):e,n=u.toBytes("1220"+t);return i.encode(n)},entropy:function(){return Math.round(1e5*Math.random())},neoDecode:function(e,t,n){if(Array.isArray(t)){if(n.length<t.length)throw new Error("casperapi: Result to short, cannont convert "+n.length+" of "+t.length);return t.map(function(t,r){return f(e,t,n[r])})}return f(e,t,n)},detectBlockchain:function(e){if(!(!e instanceof Object))return e.sign&&"eth_sign"===e.sign.call||e.eth&&e.eth.sign&&"eth_sign"===e.sign.call?"eth":e.CONST&&e.CONST.NEO_NETWORK?"neo":void 0}}},function(e,t,n){"use strict";var r=n(0);e.exports=function(e){var t=e.method,n=void 0===t?"GET":t,o=e.url,i=e.data,u=void 0===i?{}:i,c=e.file,a=e.headers,s=void 0===a?{}:a,f=e.encoding,p=void 0,l=r(function(e,t,r){var i=function(e){var t=e.loaded/e.total;t&&0<t&&t<=1&&r("progress",t)},a=new FormData;for(var l in u)a.append(l,u[l]);c&&a.append("file",c);var h=new XMLHttpRequest;for(var d in null===f&&(h.responseType="blob"),c?h.upload.onprogress=i:h.onprogress=i,h.onload=function(t){return e(h.response)},h.onerror=function(e){return t(e)},h.open(n,o),s)h.setRequestHeader(d,s[d]);h.send(a),p=h.abort.bind(h)});return l.abort=p,l}},function(e,t,n){"use strict";var r=n(2),o=n(0),i=function(e){return!e.rejected||e.canceled};e.exports=function e(t,n,u){var c=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};return o(function(o,a,s){0===(u=u.filter(function(e){return"0.0.0.0"!==e})).length&&a(new Error("casperapi: No hosts to handle request"));var f=u.map(function(e){return{ip:e,rejected:!1,canceled:!1,abortRequest:null}}),p="",l=function(e){p=e,s("new-champion",e.ip)};f.forEach(function(u){var h,d=r(Object.assign({},c,{method:t,url:n.replace("{host}",u.ip)}));u.abortRequest=d.abort,d.on("progress",(h=u,function(e){p||l(h),f.filter(function(e){return e!==p}).map(function(e){return e.abortRequest()}),h===p&&s("progress",e)})).then(function(e){p||l(u),u===p&&o(e)}).catch(function(r){if(u.rejected=!0,u===p){var l=f.filter(i).map(function(e){return e.ip});e(t,n,l,c).on("progress",function(e){return s("progress",e)}).on("new-champion",function(e){return s("new-champion",e)}).then(o).catch(function(e){a(new Error("casperapi: All hosts are unreachable"))})}else 0===f.filter(i).length&&a(new Error("casperapi: All hosts are unreachable"))})})})}},function(e,t,n){"use strict";var r=function(){return function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,t){var n=[],r=!0,o=!1,i=void 0;try{for(var u,c=e[Symbol.iterator]();!(r=(u=c.next()).done)&&(n.push(u.value),!t||n.length!==t);r=!0);}catch(e){o=!0,i=e}finally{try{!r&&c.return&&c.return()}finally{if(o)throw i}}return n}(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),o=n(1),i=o.uuidToHash,u=(o.nodeIdToBytes,o.entropy,o.neoDecode),c={development:"afbbe56378cd68fe045463bd5e3a2978f0ff37bb",production:"ff89Eb252F1E9C6638823C819DC0b2Ce3bFae7F5"},a={development:"http://195.201.96.242:30333",production:"http://195.201.96.242:30333"};e.exports={getUploadNodes:function(e,t){var n=t.fileSize,o=t.mode;return new Promise(function(t,i){var s=e.sc.createScript({scriptHash:c[o],operation:"getpeers",args:[n,1]});e.rpc.Query.invokeScript(s).execute(a[o]).then(function(e){return e.result.stack[0].value.filter(function(e){return e.value.length}).map(function(e){return e.value})}).then(function(t){return Promise.all(t.map(function(t){var n=e.sc.createScript({scriptHash:c[o],operation:"getinfo",args:[t]});return e.rpc.Query.invokeScript(n).execute(a[o]).then(function(n){var o=n.result.stack[0].value,i=u(e,[String,String],o.slice(2)),c=r(i,2),a=c[0],s=c[1];return{ip:a.replace(/:.*/,""),ipfs:s,hash:e.u.hexstring2str(t)}})}))}).then(t)})},getStoringNodes:function(e,t){var n=t.uuid,r=t.mode;return new Promise(function(t,o){var s=i(n),f=e.sc.createScript({scriptHash:c[r],operation:"getstoringpeers",args:[s.substr(2)]});e.rpc.Query.invokeScript(f).execute(a[r]).then(function(e){return e.result.stack[0].value.filter(function(e){return e.value.length}).map(function(e){return e.value})}).then(function(t){return Promise.all(t.map(function(t){var n=e.sc.createScript({scriptHash:c[r],operation:"getinfo",args:[t]});return e.rpc.Query.invokeScript(n).execute(a[r]).then(function(e){return u(String,e.result.stack[0].value[2])})}))}).then(function(e){return e.filter(function(e){return e.length})}).then(function(e){return e.map(function(e){return e.replace(/:.*/,"")})}).then(t)})}}},function(e){e.exports=[{constant:!0,inputs:[{name:"nodeID",type:"bytes32"}],name:"getNodeAddr",outputs:[{name:"",type:"string"},{name:"",type:"string"}],payable:!1,stateMutability:"view",type:"function"},{constant:!0,inputs:[{name:"fileID",type:"bytes32"}],name:"getStoringPeers",outputs:[{name:"",type:"uint256"}],payable:!1,stateMutability:"view",type:"function"},{constant:!0,inputs:[{name:"fileID",type:"bytes32"}],name:"showStoringPeers",outputs:[{name:"",type:"bytes32[]"}],payable:!1,stateMutability:"view",type:"function"},{constant:!0,inputs:[{name:"size",type:"uint256"},{name:"seed",type:"uint256"}],name:"getPeers",outputs:[{name:"",type:"bytes32[]"}],payable:!1,stateMutability:"view",type:"function"}]},function(e,t,n){"use strict";e.exports={isFile:function(e){return e instanceof Blob},getFileSize:function(e){return new Promise(function(t){if(e instanceof Blob)return t(e.size);reject(new Error("casperapi: Cannot compute file size"))})}}},function(e,t,n){"use strict";e.exports={toBytes:function(e){for(var t=[];e.length>=2;)t.push(parseInt(e.substring(0,2),16)),e=e.substring(2,e.length);return t}}},function(e,t,n){"use strict";var r="123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz",o={decode:function(e){var t=[],n=[],o=void 0,i=void 0,u=void 0,c=void 0;for(o in e)for(i=0,(u=r.indexOf(e[o]))||n.length^o||n.push(0);i in t||u;)u=(c=(c=t[i])?58*c+u:u)>>8,t[i]=c%256,i++;for(;i--;)n.push(t[i]);return new Uint8Array(n)},encode:function(e){var t=[],n="",o=void 0,i=void 0,u=void 0,c=void 0;for(o in e)for(i=0,n+=(u=e[o])||n.length^o?"":1;i in t||u;)u=(c=(c=t[i])?256*c+u:u)/58|0,t[i]=c%58,i++;for(;i--;)n+=r[t[i]];return n}};e.exports=o},function(e,t){e.exports=require("js-sha256")},function(e,t,n){"use strict";var r=n(1),o=(r.parseSCString,r.uuidToHash),i=r.nodeIdToBytes,u=r.entropy,c=n(5),a={development:"b4854255e34a089FBae02709A35ddc854D238d0C",production:"ff89Eb252F1E9C6638823C819DC0b2Ce3bFae7F5"},s={development:[],production:[]},f=function(e,t){var n=!0,r=!1,o=void 0;try{for(var i,u=s[t][Symbol.iterator]();!(n=(i=u.next()).done);n=!0){var f=i.value;if(f.eth===e)return f.sc}}catch(e){r=!0,o=e}finally{try{!n&&u.return&&u.return()}finally{if(r)throw o}}var p={eth:e,sc:new e.Contract(c,a[t])};return s[t].push(p),p.sc};e.exports={getUploadNodes:function(e,t){var n=t.fileSize,r=t.mode;return new Promise(function(t,o){var c=f(e,r);c.methods.getPeers(n,u()).call().then(function(e){var t=Object.values(e);return Promise.all(t.map(function(e){return new Promise(function(t,n){return c.methods.getNodeAddr(e).call().then(function(n){return t({ip:n[0].replace(/:.*/,""),ipfs:n[1],hash:i(e)})}).catch(n)})}))}).then(function(e){return e.filter(function(e){return e.ip})}).then(t)})},getStoringNodes:function(e,t){var n=t.uuid,r=t.mode;return new Promise(function(t,i){var u=f(e,r),c=o(n);u.methods.showStoringPeers(c).call().then(function(e){var t=Object.values(e);return Promise.all(t.map(function(e){return u.methods.getNodeAddr(e).call()}))}).then(function(e){return e.filter(function(e){return e[0]})}).then(function(e){return e.map(function(e){return e[0].replace(/:.*/,"")})}).then(t)})}}},function(e,t,n){"use strict";var r=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}();var o=n(10),i=n(4),u=n(0),c=n(3),a=n(1),s={eth:o,neo:i},f=function(){function e(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=n.blockchain,o=n.mode,i=void 0===o?"development":o;if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),void 0===(r=r||a.detectBlockchain(t)))throw new Error("casperapi: Unsupported blockchain api, use web3 / web3-eth / neon-js");this.blockchain=r,this.mode=i,"eth"===this.blockchain?this.blockchainAPI=t.eth||t:this.blockchainAPI=t}return r(e,[{key:"save",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return u(function(r,o,i){if(!a.isFile(e))throw new TypeError("casperapi: file type must be File | Blob | Buffer | stream.Readable");a.getFileSize(e).then(function(e){return s[t.blockchain].getUploadNodes(t.blockchainAPI,{fileSize:e,mode:t.mode})}).then(function(t){i("sc-connected");var u=t.map(function(e){return e.ip}),a=t.map(function(e){return e.ipfs+"/ipfs/"+e.hash}),s={"X-Peers":JSON.stringify(a)},f=void 0,p=void 0;n?(f="PUT",p="http://{host}:5001/casper/v0/file/"+n):(f="POST",p="http://{host}:5001/casper/v0/file"),c(f,p,u,{file:e,headers:s}).on("progress",function(e){return i("progress",e)}).on("new-champion",function(e){return i("node-found",e)}).then(function(e){r(JSON.parse(e).UUID)}).catch(o)}).catch(o)})}},{key:"delete",value:function(e){var t=this;return u(function(n,r,o){s[t.blockchain].getStoringNodes(t.blockchainAPI,{uuid:e,mode:t.mode}).then(function(t){o("sc-connected"),c("DELETE","http://{host}:5001/casper/v0/file/"+e,t).on("new-champion",function(e){return o("node-found",e)}).then(n).catch(r)}).catch(r)})}},{key:"getFile",value:function(e){var t=this;return u(function(n,r,o){s[t.blockchain].getStoringNodes(t.blockchainAPI,{uuid:e,mode:t.mode}).then(function(e){return o("sc-connected"),e}).then(function(t){c("GET","http://{host}:5001/casper/v0/file/"+e,t,{encoding:null}).on("progress",function(e){return o("progress",e)}).on("new-champion",function(e){return o("node-found",e)}).then(n).catch(r)}).catch(r)})}},{key:"getLink",value:function(e){var t=this;return u(function(n,r,o){var i="";s[t.blockchain].getStoringNodes(t.blockchainAPI,{uuid:e,mode:t.mode}).then(function(t){o("sc-connected"),c("POST","http://{host}:5001/casper/v0/share/"+e,t).on("new-champion",function(e){return i=e}).then(function(e){return n("http://"+i+":5001"+e)}).catch(r)}).catch(r)})}}]),e}();e.exports=f}])});